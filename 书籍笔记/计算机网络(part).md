<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [计算机网络](#计算机网络)
	- [应用层](#应用层)
		- [1.HTTP长连接和短连接](#1http长连接和短连接)
		- [2.HTTP报文](#2http报文)
		- [3.HTTP返回码](#3http返回码)
	- [传输层](#传输层)
		- [1.UDP or TCP](#1udp-or-tcp)
		- [2.TCP三次握手、四次挥手](#2tcp三次握手四次挥手)
		- [3.典型状态转移图](#3典型状态转移图)
		- [4.拥塞控制](#4拥塞控制)

<!-- /TOC -->
# 计算机网络
本文记录一些计算机网络相关的知识，用于复习
主要关注应用层和传输层

## 应用层
### 1.HTTP长连接和短连接
* 短连接每次请求维护一个全新的连接，每个连接都需要分配TCP缓冲区等，web服务器负担严重。且请求的每个对象，需要两倍的RTT
* 长连接会一直维护，直到达到设定时长没有请求才会关闭

从编写的webserver里看也基本是这样，长连接qps是短连接的3-4倍，符合上述理论
### 2.HTTP报文
![HTTP请求报文](/assets/HTTP请求报文.png)
![HTTP响应报文](/assets/HTTP响应报文_6pia0ymuj.png)
### 3.HTTP返回码
| 返回码类别 | 描述 |
| :---- | :----|
| 1** | 服务器收到请求，要求客户端继续操作 |
| 2** | 成功，请求接收并处理 |
| 3** | 重定向，需进一步操作以完成请求 |
| 4** | 客户端错误，请求错误或无法完成 |
| 5** | 服务器错误，处理中发生错误 |

常用的返回码：
* 200 OK: 请求成功，信息返回在响应报文中
* 301 Moved Permanently: 请求被转移到其他URL，并传回新的URL
* 400 Bad Request: 通用差错代码，服务器不理解请求
* 404 Not Found: 请求文档不在服务器中
* 505 HTTP Version Not Supported: 服务器不支持HTTP协议
## 传输层
### 1.UDP or TCP
* TCP包括面向连接以及可靠数据传输服务以及拥塞控制机制(有利于网络整体)
* UDP只提供必要服务的轻量级传输协议服务，不保证报文一定到达，也不保证报文一定按顺序到达。

因此，在需要可靠传输的场景中，选用TCP，在能够容忍丢失，但对速度下限要求较高的服务(网络电话、视频等多媒体服务)采用UDP。
### 2.TCP三次握手、四次挥手
* 三次握手
A->B 说明A能够发送数据
->B && B->A B能接收消息，且能发送
A->B 证明A能够发送
三次握手也就是客户端服务端互相确认对方收发没问题
* 四次挥手
A->B FIN 告知B，A将关闭发送
B->A ACK B知道A将关闭发送
B->A FIN B将关闭发送
A->B ACK 连接两端关闭
四次挥手是因为TCP是双向的数据流动，只有双方都不再发送的时候，连接才会彻底关闭
### 3.典型状态转移图
**client**: CLOSED->SYN_SENT->ESTABLISHED->FIN_WAIT_1->FIN_WAIT_2->TIME_WAIT->CLOSED
TIME_WAIT状态使TCP可客户能够重传缺失的最后ACK，如果没有，则服务端将一直等待这个ACK。
**server**: CLOSED->LISTEN->SYN_RCVD->ESTABLISHED->CLOSE_WAIT->LAST_ACK->CLOSED
### 4.拥塞控制
发送方限制未确认的数据不大于rwnd和cwnd的最小值，即:`LastByteSent - LastByteAcked <= min{cwnd, rwnd}`。

TCP以慢启动开始，如果发生丢包，则cwnd重设为1，ssthresh为cwnd/2。如果cwnd>=ssthresh，则cwnd不翻倍，而是更为谨慎的增大(+MSS)。如果连续收到3个冗余ACK，则进入快速恢复状态(ssthresh = cwnd/2, cwnd = ssthresh)。

## 网络层(数据层面)

### 1.IPv4数据报
![IPv4](/assets/IPv4.jfif)
* **4版本**，有4(IPv4)和6(IPv6)
* **4首部长度**，因为IP首部中有可选部分，所以需要这部分指示出数据报中有效载荷开始的地方
* **8区分服务**，区分不同类型的IP数据报，一般不使用
* **总长度**，IP数据报总长度，一般不超过1500bytes
* **生存时间**，TTL，防止无法交互的数据报在网络中循环打转，每当一台路由处理时会把该值-1，到0被丢弃。
* **协议**，到达终点才会被使用，指示上层交由哪个协议进行处理，如ICMP，TCP，UDP等。
* **首部检验和**，因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
* **源和目的地址**，当某源生成一个数据报时，会在源IP插入自己的IP，在目的IP插入最终的目的IP
* **标识、标志、片偏移**，与IP分片有关，因为IP数据报最终会被送入链路层传送，而且链路层协议有着MTU(最大传输单元的限制)，所以数据报大小不能无限大，因此需要分片措施。
	* 标识，用来区分分片后数据报的顺序
	* 标志，用来区分是否是尾数据报，尾为0，其余为1
	* 片偏移，用来指示分片以前的位置，单位为8字节

### 2.IPv4编址
使用网络前缀和主机号对IP进行编码，例如a.b.c.d/x表示前x位为网络前缀，后面为主机号。

对于子网外部的路由器，只转发时只考虑匹配前x位，并且，在路由器转发时会选择**最长前缀匹配**来确定该匹配哪一个。

255.255.255.255为广播地址，会被交付给子网的所有主机。
### 3.网络地址转换(NAT)
具有专业地址地域是指其地址只对该网络中的设备有意义的网络。

对于NAT使能的路由器来说，他对外界隐藏了内部家庭网络实现的细节。

内部网络通过DHCP向路由器获取自身IP，但发送到外网时都拥有同一个IP。

外部流入内网通过NAT路由器上的转换表来转发给内部主机，该表中包含了端口号和IP。

## 网络层(控制层面)

路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。

互联网可以划分为许多较小的自治系统 AS，一个 AS 可以使用一种和别的 AS 不同的路由选择协议。

因此可以把路由选择分为两大类：
* 自洽系统内部的路由选择：RIP和OSPF
* 自洽系统外部的路由选择：BGP

### 1.内部网管协议(RIP)
RIP 是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

距离向量算法：
* 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
* 对修改后的 RIP 报文中的每一个项目，进行以下步
	* 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
	* 否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
	* 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。
### 2.开放最短路径优先(OSPF)
开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：
* 向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
* 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
* 只有当链路状态发生变化时，路由器才会发送信息。
### 3.边界网关协议(BGP)
AS和AS之间运行BGP协议，BGP协议需要做两件事：
* 从邻居AS获得前缀可达性信息
* 确定到该前缀“最好”的路由

1. 通告BGP信息：
网关路由器通过外部BGP(eBGP)传递前缀到相邻AS，并且通过内部BGP(iBGP)通知AS内的各个路由器。

2. 确定“最好”路由：
	BGP在通告前缀时，还有一些额外的属性，我们关注两个，AS-PATH属性包含了通告已经通过的AS的列表，NEXT-HOP是AS-PATH起始的路由器接口的IP。
	* 热土豆路由选择：挑选到NEXT-HOP路由最小开销，这是为了尽可能快地将分组发送出AS。
	* 实际路由选择算法：首先根据本地偏好，然后根据最短AS-PATH，再使用热土豆。

### 4.ICMP因特网控制报文协议
ICMP位于网络层，是承载在IP分组中的。

ICMP分为差错报文和询问报文。
![ICMP](/assets/ICMP.png)

* Ping
	Ping是ICMP的一个重要应用，用来测试两台主机之间的连通性。

	Ping通过ICMP发送Echo请求报文，主机收到后，回复Echo报文。根据时间和响应次数估算RTT和丢包率。
* Traceroute
	Traceroute 是 ICMP 的另一个应用，用来跟踪一个分组从源点到终点的路径。

	Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文。
	* 发送一系列TTL递增的IP数据报
	* 路由回复TTL为0的报文ICMP警告
	* 到达目的主机，目的主机回复端口不可达的ICMP报文

## 链路层
链路层负责的是每段链路之间的通信，因为每个设备都有唯一的MAC地址，在子网内我们通过MAC地址就可以确定收发方。

只用MAC地址即可标记所有设备，IP的意义在于采用了网络地址+主机地址的方式，可以分辨出是否在同一子网下，不在即可发送给网关，而MAC地址由于每个设备的唯一性不具有IP这种拓扑结构，难以实现这一的操作。


### 1.地址解析协议(ARP)
ARP协议负责将IP地址转换为ARP地址。

每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表，不是所有都要在表上，而且表项的有效时间大约为20分钟。

当主机A知道B的IP地址，但是ARP缓存中没有MAC，此时会广播ARP请求分组，B收到后，会将ARP响应发给A，告知MAC地址。
